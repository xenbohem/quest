<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vampish — Nocturnal Quest</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Cinzel:wght@400;700&family=VT323&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#05030a;
    --bg2:#12001a;
    --cornflower:#6495ED;
    --accent1:#8a2be2;
    --accent2:#550066;
    --muted:#cfc1e6;
    --neon:#c97bff;
    --glass: rgba(255,255,255,0.03);
    --base:18px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial; background:
    radial-gradient(800px 400px at 12% 8%, rgba(100,149,237,0.08), transparent),
    linear-gradient(180deg,var(--bg1),var(--bg2)); color:#efe8ff;font-size:var(--base);-webkit-font-smoothing:antialiased;}
  /* Fullscreen intro / login */
  .intro {
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:60;
    background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.6));
    backdrop-filter: blur(6px);
  }
  .intro-card{
    width:min(880px,94%);border-radius:14px;padding:28px;background:linear-gradient(180deg, rgba(12,4,18,0.9), rgba(6,2,10,0.92));
    box-shadow:0 30px 90px rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.04);
    display:flex;gap:22px;align-items:center;flex-wrap:wrap; justify-content:space-between;
  }
  .intro-left{flex:1;min-width:260px}
  .brand{
    font-family:Cinzel, serif;color:var(--cornflower);font-size:56px;letter-spacing:4px;text-shadow:0 6px 28px rgba(100,149,237,0.12);
    margin:0;padding:0;
  }
  .brand-sub{font-family:VT323,monospace;color:var(--muted);margin-top:6px;}
  .intro-right{min-width:340px;max-width:420px;background:rgba(255,255,255,0.02);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
  .muted{color:var(--muted)}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--cornflower));border:none;color:#fff}
  .field{display:flex;gap:8px;align-items:center;margin-top:10px}
  .codeBadge{font-family:VT323,monospace;background:linear-gradient(90deg,var(--accent1),var(--accent2));padding:10px 14px;border-radius:8px;color:#fff;letter-spacing:6px}
  input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
  label{font-size:0.9rem;color:var(--muted)}

  /* main layout after login */
  .app{
    max-width:1200px;margin:30px auto;padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);
    display:grid;grid-template-columns:420px 1fr;gap:18px;align-items:start;
  }
  .card{padding:16px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.02)}
  .dos{font-family:VT323,monospace;background:rgba(0,0,0,0.25);padding:12px;border-radius:8px;color:var(--muted);height:120px;overflow:auto}
  .section-title{font-family:Cinzel,serif;color:var(--neon);margin-bottom:6px}
  .chat-log{height:46vh;overflow:auto;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));display:flex;flex-direction:column;gap:10px}
  .bubble{max-width:80%;padding:12px 16px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:#efe8ff;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
  .bubble.bot{align-self:flex-start;background:linear-gradient(180deg, rgba(138,43,226,0.06), rgba(85,0,102,0.04));font-family:VT323,monospace;color:var(--muted)}
  .bubble.me{align-self:flex-end;background:linear-gradient(90deg,var(--cornflower), rgba(100,149,237,0.12));color:#fff}
  .input-row{display:flex;gap:8px;margin-top:10px}

  /* hidden codex drawer kept fully off-screen */
  .codex-drawer{position:fixed;right:-9999px;top:0;width:360px;height:100%;background:#120013;z-index:1000}
  /* small responsive */
  @media (max-width:980px){
    .app{grid-template-columns:1fr}
    .brand{font-size:44px}
    .intro-card{padding:18px}
  }
</style>
</head>
<body>

<!-- Fullscreen intro / login -->
<div id="intro" class="intro" role="dialog" aria-modal="true">
  <div class="intro-card" role="document" aria-label="Vampish sign-in">
    <div class="intro-left">
      <h1 class="brand">vampish</h1>
      <div class="brand-sub">curate your nocturnal essence</div>

      <p class="muted" style="margin-top:18px">
        A ritual login is required. You'll receive a one-time 5-letter access code. Save it if you want to return, or let the browser remember you for 24 hours.
      </p>

      <div style="margin-top:18px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="introLoginBtn" class="btn primary">Log in</button>
        <button id="introRestoreBtn" class="btn">Have a code?</button>
      </div>
    </div>

    <div class="intro-right" aria-hidden="false">
      <!-- dynamic content: either greeting, code display, or restore input -->
      <div id="introState">
        <div style="font-weight:700">Sign-in</div>
        <div class="muted" style="margin-top:6px">Start here to enter the Nocturnal Quest.</div>
      </div>
      <div id="introActions" style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <!-- Name input for code generation -->
        <div id="nameBox" style="display:none">
          <label for="introName">Display name</label>
          <input id="introName" type="text" placeholder="What should we call you?" />
        </div>

        <!-- Show generated code area -->
        <div id="generatedArea" style="display:none;align-items:center;gap:12px">
          <div class="codeBadge" id="introCode">ABCDE</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;gap:8px">
              <button id="introCopyBtn" class="btn">Copy</button>
              <button id="introSaveBtn" class="btn">Save file</button>
            </div>
            <div class="muted">Type the code below to confirm and continue.</div>
            <input id="confirmCode" type="text" placeholder="Enter code to confirm" />
            <div style="display:flex;gap:8px">
              <label style="display:flex;gap:8px;align-items:center;color:var(--muted)">
                <input id="introKeep" type="checkbox" checked /> keep me logged in 24h
              </label>
              <div style="flex:1"></div>
              <button id="introConfirmBtn" class="btn primary">Confirm</button>
            </div>
          </div>
        </div>

        <!-- Restore area -->
        <div id="restoreArea" style="display:none;gap:8px">
          <label class="muted">Paste your 5-letter code</label>
          <input id="restoreInputIntro" type="text" placeholder="ABCDE" />
          <div style="display:flex;gap:8px">
            <button id="restoreConfirmBtn" class="btn primary">Restore</button>
            <button id="restoreCancelBtn" class="btn">Cancel</button>
          </div>
        </div>

        <!-- Welcome when there's an active saved session -->
        <div id="welcomeArea" style="display:none">
          <div style="font-weight:700" id="welcomeText">Welcome, guest</div>
          <div class="muted" style="margin-top:6px">Click Start to enter the quest (session will persist for 24h).</div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="welcomeStartBtn" class="btn primary">Start</button>
            <button id="welcomeLogoutBtn" class="btn">Logout</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Main app (hidden until login) -->
<main id="app" class="app" style="display:none" role="main" aria-live="polite">
  <!-- left column -->
  <section class="card">
    <div class="section-title">Nocturne Console</div>
    <div class="dos" id="dosArea" aria-live="polite">
      INIT.Nocturne v2.0<br/>Establishing moonlink...
    </div>

    <div id="consoleControl" style="margin-top:12px">
      <div id="consolePrompt" class="muted">Say your name on the right to begin the trial.</div>
      <div id="consoleChoices" style="margin-top:10px"></div>
    </div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">

    <div class="section-title">Result & Certificate</div>
    <div class="muted">After completing the trial the certificate will appear here.</div>
    <div id="resultCard" style="margin-top:12px">
      <div id="resultIntro" style="font-weight:700;color:var(--neon);font-family:Cinzel,serif">Awaiting initiation...</div>
      <div id="resultBody" class="muted" style="margin-top:8px">Complete the trial to receive your certificate.</div>

      <div id="certPreviewArea" style="display:none;margin-top:12px">
        <div class="cert-thumb" id="certThumb">Preview</div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px">
          <button id="downloadBtn" class="btn">Download PNG</button>
          <button id="saveDiskBtn" class="btn">Save to disk...</button>
        </div>
      </div>
    </div>

    <div style="margin-top:14px">
      <div class="section-title" style="font-size:16px">Local Archive</div>
      <div class="saved" id="savedList" style="min-height:100px">No certificates saved yet.</div>
    </div>
  </section>

  <!-- right column: chat + login name + controls -->
  <aside class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="section-title">Nocturne Chat</div>
        <div class="muted">Dialogue appears here.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
    </div>

    <div id="chatLog" class="chat-log" role="log" aria-live="polite"></div>

    <div class="input-row">
      <input id="userNameField" type="text" placeholder="What should we call you?" aria-label="Your name">
      <button id="respondBtn" class="btn primary">Start</button>
    </div>
    <div style="margin-top:8px" class="muted">Your name is kept locally for personalization.</div>
  </aside>
</main>

<!-- hidden canvas for certificate -->
<canvas id="certCanvas" width="1400" height="800" style="display:none"></canvas>

<script>
/* Vampish — single-file client-side app
   - Fullscreen intro/login that hands out 5-letter codes.
   - Code may be saved locally for 24 hours.
   - After successful login, the quest UI appears (app).
   - Logout returns to intro screen. All local only.
   - Remember to change adminEmail if you want the help mailto to address you.
*/

const adminEmail = "admin@example.com"; // <-- replace before using

// Storage keys
const CODE_KEY = 'vampish_code_v1';
const SESSION_KEY = 'vampish_session_v1';
const CERTS_KEY = 'vampish_certs_v1';
const LORE_KEY = 'vampish_lore_v1';
const AVATAR_KEY = 'vampish_avatar_v1';

// DOM refs
const intro = document.getElementById('intro');
const introLoginBtn = document.getElementById('introLoginBtn');
const introRestoreBtn = document.getElementById('introRestoreBtn');
const introState = document.getElementById('introState');
const nameBox = document.getElementById('nameBox');
const introName = document.getElementById('introName');
const generatedArea = document.getElementById('generatedArea');
const introCode = document.getElementById('introCode');
const introCopyBtn = document.getElementById('introCopyBtn');
const introSaveBtn = document.getElementById('introSaveBtn');
const introConfirmBtn = document.getElementById('introConfirmBtn');
const introKeep = document.getElementById('introKeep');
const confirmCode = document.getElementById('confirmCode');
const restoreArea = document.getElementById('restoreArea');
const restoreInputIntro = document.getElementById('restoreInputIntro');
const restoreConfirmBtn = document.getElementById('restoreConfirmBtn');
const restoreCancelBtn = document.getElementById('restoreCancelBtn');
const welcomeArea = document.getElementById('welcomeArea');
const welcomeText = document.getElementById('welcomeText');
const welcomeStartBtn = document.getElementById('welcomeStartBtn');
const welcomeLogoutBtn = document.getElementById('welcomeLogoutBtn');

const app = document.getElementById('app');
const chatLog = document.getElementById('chatLog');
const userNameField = document.getElementById('userNameField');
const respondBtn = document.getElementById('respondBtn');
const logoutBtn = document.getElementById('logoutBtn');

const dosArea = document.getElementById('dosArea');
const consolePrompt = document.getElementById('consolePrompt');
const consoleChoices = document.getElementById('consoleChoices');

const questArea = document.getElementById('questArea');
const resultIntro = document.getElementById('resultIntro');
const resultBody = document.getElementById('resultBody');
const certPreviewArea = document.getElementById('certPreviewArea');
const certThumb = document.getElementById('certThumb');
const downloadBtn = document.getElementById('downloadBtn');
const saveDiskBtn = document.getElementById('saveDiskBtn');
const savedList = document.getElementById('savedList');

const codexDrawer = document.getElementById('codexDrawer');
const toggleCodexBtn = document.getElementById('toggleCodexBtn');
const codexCloseBtn = document.getElementById('codexCloseBtn');
const includeLoreCheckbox = document.getElementById('includeLoreCheckbox');
const codexSaveBtn = document.getElementById('codexSaveBtn');

const canvas = document.getElementById('certCanvas');
const ctx = canvas.getContext('2d');

// data
let session = null; // { name, code, expiry }
let generatedCode = null;
let loreSettings = { includeLore: false };
let state = { name:null, qIndex:-1, scores:{}, answers:[], lastCert:null };
let activeQuestions = [];

// small utilities
function randCode(n=5){
  const A = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"; let s='';
  for(let i=0;i<n;i++) s += A[Math.floor(Math.random()*A.length)];
  return s;
}
function nowMs(){ return Date.now(); }
function in24hMs(){ return nowMs() + 24*60*60*1000; }
function saveSessionLocal(code, name, expiryMs){
  localStorage.setItem(SESSION_KEY, JSON.stringify({ code, name, expiry: expiryMs }));
}
function readSavedSession(){
  try{
    const raw = JSON.parse(localStorage.getItem(SESSION_KEY) || 'null');
    if(!raw) return null;
    if(raw.expiry && Date.now() > raw.expiry){ localStorage.removeItem(SESSION_KEY); return null; }
    return raw;
  }catch(e){ return null; }
}
function clearSavedSession(){ localStorage.removeItem(SESSION_KEY); }

// chat / console helpers
function showBubble(text, who='bot'){
  const el = document.createElement('div'); el.className = 'bubble ' + (who==='me' ? 'me' : 'bot'); el.textContent = text;
  chatLog.appendChild(el); chatLog.scrollTop = chatLog.scrollHeight;
}
function addConsolePrompt(text){ consolePrompt.textContent = text; }

// load avatar (kept minimal)
function loadAvatar(){
  const raw = localStorage.getItem(AVATAR_KEY);
  // not used visually in this iteration, but preserved for future
  return raw || null;
}

// intro logic
function resetIntroState(){
  // hide everything except primary message
  nameBox.style.display = 'none';
  generatedArea.style.display = 'none';
  restoreArea.style.display = 'none';
  welcomeArea.style.display = 'none';
  introState.style.display = 'block';
}
function showWelcomeForSaved(saved){
  // saved: { code, name, expiry }
  welcomeArea.style.display = 'block';
  welcomeText.textContent = `Welcome, ${saved.name || 'traveler'}`;
  nameBox.style.display = 'none';
  generatedArea.style.display = 'none';
  restoreArea.style.display = 'none';
}
introLoginBtn.addEventListener('click', ()=>{
  // begin login: ask for display name and generate code
  resetIntroState();
  nameBox.style.display = 'block';
  generatedArea.style.display = 'none';
  restoreArea.style.display = 'none';
});
introRestoreBtn.addEventListener('click', ()=>{
  resetIntroState();
  restoreArea.style.display = 'flex';
  nameBox.style.display = 'none';
});
// generate code when name provided (on first showing generated area)
function createGeneratedCode(){
  const nm = (introName.value || '').trim() || 'NoName';
  generatedCode = randCode(5);
  introCode.textContent = generatedCode;
  generatedArea.style.display = 'flex';
  confirmCode.value = '';
  // show hint in chat
  showBubble('A ceremonial code has been generated. Save it or allow the browser to remember it for 24 hours.', 'bot');
}
introName.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ createGeneratedCode(); }});
newFunction = null;
document.addEventListener('click', (e)=>{}); // placeholder to keep event order predictable

introCopyBtn.addEventListener('click', async ()=>{
  if(!generatedCode) return;
  try{ await navigator.clipboard.writeText(generatedCode); showBubble('Code copied to clipboard.', 'bot'); } catch(e){ alert('Copy failed.'); }
});
introSaveBtn.addEventListener('click', ()=>{
  if(!generatedCode) return;
  const blob = new Blob([`Vampish access code: ${generatedCode}\nKeep it safe.`], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `vampish-code-${generatedCode}.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  showBubble('Saved code to file.', 'bot');
});
introConfirmBtn.addEventListener('click', ()=>{
  const entered = (confirmCode.value || '').trim().toUpperCase();
  if(!generatedCode) return alert('No code generated yet.');
  if(entered !== generatedCode) return alert('The code you entered does not match the generated code.');
  // success: store session if keep checked
  const keep = !!introKeep.checked;
  const nm = (introName.value || '').trim() || 'NoName';
  session = { code: generatedCode, name: nm, expiry: keep ? in24hMs() : null };
  if(keep) saveSessionLocal(session.code, session.name, session.expiry);
  // hide intro and open app
  openAppAfterLogin(session);
});
restoreConfirmBtn.addEventListener('click', ()=>{
  const val = (restoreInputIntro.value || '').trim().toUpperCase();
  if(!/^[A-Z]{5}$/.test(val)) return alert('Enter a valid 5-letter code.');
  // Try to match a saved session code if present; if not, create a transient session with name unknown and let the user proceed (they will set name)
  const saved = readSavedSession();
  if(saved && saved.code === val){
    session = saved;
    openAppAfterLogin(session);
  } else {
    // Allow restore as transient: ask for name then proceed
    const nm = prompt('No local session found for that code. Enter a display name to proceed (this will be a transient session):') || 'NoName';
    session = { code: val, name: nm, expiry: null };
    openAppAfterLogin(session);
  }
});
restoreCancelBtn.addEventListener('click', ()=>{ resetIntroState(); });

// welcome buttons
welcomeStartBtn.addEventListener('click', ()=>{
  const saved = readSavedSession();
  if(saved) { session = saved; openAppAfterLogin(session); } else { resetIntroState(); }
});
welcomeLogoutBtn.addEventListener('click', ()=>{
  clearSavedSession();
  resetIntroState();
  introState.querySelector('div').textContent = 'Sign-in';
});

// If a saved session exists on load, show welcome
function attemptAutoWelcome(){
  const saved = readSavedSession();
  if(saved){
    // prefill intro UI and show welcome
    resetIntroState();
    showWelcomeForSaved(saved);
    introCode.textContent = saved.code;
    welcomeArea.style.display = 'block';
  } else {
    resetIntroState();
  }
}

// finalize login and show app
function openAppAfterLogin(sess){
  // set global state name if present
  state.name = sess.name || '';
  // hide intro overlay
  intro.style.display = 'none';
  // show main app
  app.style.display = 'grid';
  // prefill name field
  userNameField.value = state.name || '';
  // initial chat greeting
  if(state.name) showBubble(`Welcome ${state.name}. The night acknowledges you.`, 'bot');
  else showBubble('Session begun. Provide a name to personalize your trial.', 'bot');
  // focus name field
  userNameField.focus();
  // prepare questions
  try{ loreSettings = JSON.parse(localStorage.getItem(LORE_KEY) || '{}') || {}; }catch(e){ loreSettings = { includeLore:false }; }
  activeQuestions = (loreSettings.includeLore ? LORE_QUESTIONS.concat(BASE_QUESTIONS) : BASE_QUESTIONS.slice());
  renderSavedList();
  dosArea.scrollTop = dosArea.scrollHeight;
}

// logout: hide app & show intro again; clear non-persistent session
logoutBtn.addEventListener('click', ()=>{
  if(!confirm('Log out and return to the login screen?')) return;
  // clear saved session and in-memory
  clearSavedSession();
  session = null;
  // reset UI
  app.style.display = 'none';
  intro.style.display = 'flex';
  chatLog.innerHTML = '';
  // show intro welcome default
  resetIntroState();
  attemptAutoWelcome();
});

// respond button to begin quest flow (asks consent then questions)
respondBtn.addEventListener('click', ()=>{
  const name = (userNameField.value || '').trim();
  if(!name){ userNameField.focus(); return; }
  state.name = name;
  showBubble(`Name set: ${name}`, 'me');
  // begin consent prompt in console
  addConsolePrompt('Nocturne asks: Do you consent to the trial?');
  presentYesNoInConsole();
});

// small console functions for quest
function presentYesNoInConsole(){
  consoleChoices.innerHTML = '';
  const yes = document.createElement('button'); yes.className='btn primary'; yes.textContent='Yes';
  const no = document.createElement('button'); no.className='btn'; no.textContent='No';
  yes.onclick = ()=>{ showBubble('Yes','me'); consoleChoices.innerHTML=''; startQuestions(); };
  no.onclick = ()=>{ showBubble('No','me'); consoleChoices.innerHTML=''; addConsolePrompt('Trial declined.'); showBubble('Very well. Return when moonlight calls.','bot'); };
  consoleChoices.appendChild(yes); consoleChoices.appendChild(no);
}

const BASE_QUESTIONS = [
  { q: "You step into the moonlit courtyard. What draws your attention first?", a:[
    {t:'Aristocrat', text:'A grand chandelier and marble statues.'},
    {t:'Nosferatu', text:'A shadowed drain leading to the sewers.'},
    {t:'NightHunter', text:'A rusted crossbow hidden behind ivy.'},
  ]},
  { q: "What do you sip from the chalice?", a:[
    {t:'Bloodseer', text:'A mysterious crimson liquid that whispers.'},
    {t:'Aristocrat', text:'A rare wine, aged and refined.'},
    {t:'Nosferatu', text:'Cold iron water, bitter but necessary.'},
  ]},
  { q: "Your power is strongest when:", a:[
    {t:'Ancient', text:'You stand atop a ruined altar and remember old names.'},
    {t:'NightHunter', text:'You hunt beneath rainy rooftops.'},
    {t:'Bloodseer', text:'You peer into reflections and dream of futures.'},
  ]},
  { q: "A rival approaches. You:", a:[
    {t:'Aristocrat', text:'Invite them politely to a duel of wits.'},
    {t:'Nosferatu', text:'Lurk and strike when they are alone.'},
    {t:'NightHunter', text:'Traps and precision — you never miss.'},
  ]},
  { q: "Your emblem would most likely be:", a:[
    {t:'Bloodseer', text:'An eye within a crescent moon.'},
    {t:'Ancient', text:'A ringed star, weathered by time.'},
    {t:'Aristocrat', text:'A fleur-de-lune embroidered in silver.'},
  ]},
  { q: "Choose a companion:", a:[
    {t:'Nosferatu', text:'A roguish alley fox with daring.'},
    {t:'Bloodseer', text:'A raven that carries secrets.'},
    {t:'Ancient', text:'A slow tortoise, ancient as stone.'},
  ]},
  { q: "Your philosophy:", a:[
    {t:'NightHunter', text:'Purpose is honed by the hunt.'},
    {t:'Aristocrat', text:'Beauty and influence shape the night.'},
    {t:'Bloodseer', text:'Knowledge leaks between the folds of dreams.'},
  ]},
];
const LORE_QUESTIONS = [
  { q: "A ritual is offered — you must either give or receive. You:", a:[
    {t:'Bloodseer', text:'Accept to see what visions it opens.'},
    {t:'Aristocrat', text:'Refuse politely — rituals are for the desperate.'},
    {t:'Ancient', text:'Participate slowly; every ritual costs a memory.'},
  ]},
  { q: "A symbol stands before you (a cross, a chalice, a broken crown). You:", a:[
    {t:'Nosferatu', text:'Use it as cover and step into shadow.'},
    {t:'Bloodseer', text:'Read its story for hidden omens.'},
    {t:'Aristocrat', text:'Wear it as an emblem and command attention.'},
  ]},
];

function startQuestions(){
  // prepare questions
  const includeLore = !!(JSON.parse(localStorage.getItem(LORE_KEY) || '{}') || {}).includeLore;
  activeQuestions = includeLore ? LORE_QUESTIONS.concat(BASE_QUESTIONS) : BASE_QUESTIONS.slice();
  state.qIndex = 0; state.scores = {}; state.answers = [];
  presentQuestion();
}
function presentQuestion(){
  consoleChoices.innerHTML = '';
  if(state.qIndex >= activeQuestions.length) return concludeQuest();
  const q = activeQuestions[state.qIndex];
  addConsolePrompt(q.q);
  // mirror to chat as bot
  showBubble(`Q${state.qIndex+1}: ${q.q}`, 'bot');
  const container = document.createElement('div');
  container.style.display = 'flex'; container.style.flexDirection = 'column'; container.style.gap = '8px';
  q.a.forEach(opt=>{
    const b = document.createElement('button'); b.className='btn'; b.textContent = opt.text;
    b.onclick = ()=> {
      // disable options immediately
      Array.from(container.children).forEach(ch => ch.disabled = true);
      showBubble(opt.text, 'me');
      // record
      state.answers.push({ q: state.qIndex+1, type: opt.t, text: opt.text });
      state.scores[opt.t] = (state.scores[opt.t] || 0) + 1;
      state.qIndex++;
      setTimeout(()=> {
        if(state.qIndex < activeQuestions.length) presentQuestion(); else concludeQuest();
      }, 420);
    };
    container.appendChild(b);
  });
  consoleChoices.appendChild(container);
}

function determineType(){
  const keys = Object.keys(TYPES);
  let best=null, bestScore=-1;
  keys.forEach(k=>{ const s = state.scores[k] || 0; if(s > bestScore){ best = k; bestScore = s; }});
  const tied = keys.filter(k => (state.scores[k] || 0) === bestScore);
  return tied.length === 1 ? tied[0] : tied.join(' + ');
}

function concludeQuest(){
  const typeKey = determineType();
  const info = TYPES[typeKey] || { title: typeKey, desc: 'A unique nocturnal synthesis.'};
  resultIntro.textContent = info.title;
  resultBody.textContent = info.desc;
  const png = generateCertificatePNG(state.name || 'No Name', info.title, info.desc);
  certThumb.style.backgroundImage = `url(${png})`;
  certPreviewArea.style.display = 'block';
  const cert = { name: state.name || 'No Name', type: info.title, desc: info.desc, date: new Date().toISOString(), png };
  // store
  addToArchive(cert);
  state.lastCert = cert;
  saveStateLocally();
  showBubble(`The trial concludes. You are: ${info.title}`, 'bot');
}

// certificate canvas
function generateCertificatePNG(name, typeTitle, typeDesc){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const g = ctx.createLinearGradient(0,0,canvas.width,canvas.height); g.addColorStop(0,'#120016'); g.addColorStop(1,'#3b0640');
  ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 8; roundRect(ctx,40,40,canvas.width-80,canvas.height-80,30); ctx.stroke();
  ctx.fillStyle = 'rgba(255,255,255,0.96)'; ctx.font = '44px Cinzel, serif'; ctx.textAlign='center'; ctx.fillText('Certificate of Nocturnal Essence', canvas.width/2, 140);
  ctx.fillStyle = 'rgba(100,149,237,0.96)'; ctx.font='36px Cinzel, serif'; ctx.fillText(typeTitle, canvas.width/2, 200);
  ctx.font = '64px VT323, monospace'; ctx.fillStyle = '#fff'; ctx.fillText(name, canvas.width/2, 300);
  ctx.font = '20px VT323, monospace'; ctx.fillStyle = 'rgba(255,255,255,0.9)'; wrapText(ctx, `This certifies that ${name} completed the Nocturnal Quest and its traits align with "${typeTitle}". ${typeDesc}`, canvas.width/2, 340, canvas.width-320, 28);
  const now = new Date(); ctx.font = '18px VT323, monospace'; ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.fillText(`Issued: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, canvas.width/2, 520);
  const serial = 'NV-' + Math.random().toString(36).slice(2,10).toUpperCase(); ctx.fillText(`Serial: ${serial}`, canvas.width/2, 556);
  ctx.strokeStyle = 'rgba(100,149,237,0.16)'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(220,600); ctx.bezierCurveTo(460,560,940,640,1180,600); ctx.stroke();
  return canvas.toDataURL('image/png');
}
function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words = text.split(' '); let line=''; for(let n=0;n<words.length;n++){ const test = line + words[n] + ' '; if(ctx.measureText(test).width > maxWidth && n>0){ ctx.fillText(line,x,y); line = words[n] + ' '; y += lineHeight; } else line = test; } ctx.fillText(line,x,y); return y;
}

// archive
function addToArchive(cert){
  const arr = JSON.parse(localStorage.getItem(CERTS_KEY) || '[]');
  arr.unshift(cert); if(arr.length>12) arr.pop(); localStorage.setItem(CERTS_KEY, JSON.stringify(arr)); renderSavedList();
}
function renderSavedList(){
  const arr = JSON.parse(localStorage.getItem(CERTS_KEY) || '[]');
  if(!arr.length){ savedList.textContent = 'No certificates saved yet.'; return; }
  savedList.innerHTML = '';
  arr.forEach(c=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginBottom='8px';
    const left = document.createElement('div'); left.innerHTML = `<strong style="color:#fff">${escapeHtml(c.name)}</strong> — <span style="color:var(--muted)">${escapeHtml(c.type)}</span><div style="font-size:0.9rem;color:var(--muted)">${new Date(c.date).toLocaleString()}</div>`;
    const right = document.createElement('div'); const d = document.createElement('button'); d.className='btn'; d.textContent='Download PNG'; d.onclick = ()=>downloadDataUrl(c.png, `certificate-${c.name.replace(/\s+/g,'_')}.png`);
    right.appendChild(d); row.appendChild(left); row.appendChild(right); savedList.appendChild(row);
  });
}
function downloadDataUrl(dataUrl, filename){ const a=document.createElement('a'); a.href=dataUrl; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }

// persist state (simple)
function saveStateLocally(){ localStorage.setItem('vampish_state', JSON.stringify(state)); }

// helpers
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>'&#'+m.charCodeAt(0)+';'); }

// small initialization: check for saved session
(function init(){
  loadAvatar();
  const saved = readSavedSession();
  if(saved){
    // show welcome branch
    resetIntroState();
    showWelcomeForSaved(saved);
    intro.style.display = 'flex';
    // keep intro visible
  } else {
    resetIntroState();
    intro.style.display = 'flex';
  }
  // wire some extra interactions
  // when user requests to begin login flow, generate code when they finish entering name (or press Log in again)
  introLoginBtn.addEventListener('click', ()=>{
    // show name box if hidden
    resetIntroState();
    nameBox.style.display = 'block';
  });
  // generate code once the name field loses focus or user types Enter
  introName.addEventListener('blur', ()=>{ if(introName.value.trim()) createGeneratedCode(); });
  introName.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && introName.value.trim()) createGeneratedCode(); });

  // allow quick restore from the initial button
  introRestoreBtn.addEventListener('click', ()=>{ resetIntroState(); restoreArea.style.display='flex'; });

  // auto attempt restore on page load (if saved and user hits start on welcome)
  welcomeStartBtn.addEventListener('click', ()=> {
    const saved = readSavedSession();
    if(saved){ session = saved; openAppAfterLogin(session); } else { resetIntroState(); }
  });

  // If a saved session exists but the user clicks "Log in" we should show the code area so they can copy/save it
  const auto = readSavedSession();
  if(auto){
    // display welcome area
    resetIntroState(); showWelcomeForSaved(auto);
  }

  // restore confirm already hooked earlier; provide a fallback: if user types a code into confirm input, allow clicking Confirm
  confirmCode.addEventListener('keydown', (e)=>{ if(e.key==='Enter') introConfirmBtn.click(); });

  // handle copying/saving shortcuts
  introCopyBtn.addEventListener('click', ()=>{ if(!generatedCode) return alert('No code yet'); try{ navigator.clipboard.writeText(generatedCode); showBubble('Code copied', 'bot'); }catch(e){ alert('Copy failed'); }});
  introSaveBtn.addEventListener('click', ()=>{ if(!generatedCode) return; const blob = new Blob([`Vampish code: ${generatedCode}`], {type:'text/plain'}); const u=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=u; a.download=`vampish-${generatedCode}.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u); showBubble('Saved file', 'bot'); });

  // restore confirm
  restoreConfirmBtn.addEventListener('click', ()=>{ const val=(restoreInputIntro.value||'').trim().toUpperCase(); if(!/^[A-Z]{5}$/.test(val)) return alert('Enter a valid 5-letter code'); const s = readSavedSession(); if(s && s.code===val){ session = s; openAppAfterLogin(session); } else { // transient session, ask name then proceed
    const nm = prompt('No local session found for that code. Enter a display name to proceed:','NoName') || 'NoName';
    session = { code: val, name: nm, expiry: null }; openAppAfterLogin(session);
  } });

  // ensure archive displays if present
  renderSavedList();
})();

</script>
</body>
</html>
